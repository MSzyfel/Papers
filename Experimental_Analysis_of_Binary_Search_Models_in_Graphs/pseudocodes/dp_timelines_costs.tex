\begin{algorithm}
\caption{The dynamic programming procedure finding $\OPT'\br{T_{v,i}, P}$ ($k,p,c,n,d$ and $\mathcal{A}$ are global parameters).}\label{dp_timelines_costs}
\SetKwProg{Fn}{Procedure}{:}{}
\Fn{\FDPTimelinesCosts{$T_{v,i}, P$}}{
    \If{$i=0$}{
        \For{$1\leq b\leq d$ and $0\leq s\leq \br{k/pn \text{\textbf{ if} }c\br{v}>pk \text{\textbf{ else} 0}}$}{
            $D\gets P$.

            Try putting query to $v$ at the $s$-th slot of $q_b$.

            \If{\textnormal{$D$ is not conflicted.}}{
                \For{$D'\in \mathcal{A}[v]$}{
                    Hang $D'$ below query to $v$ in $D$.
                }
                \Return $D$ \textbf{if} $\COST'_{D}\br{T_{v,i},c,k}\leq dk$, \textbf{else} $\emptyset$.
            }
        }
        \Return{$\emptyset$}.
    }
    $\mathcal{D}\gets\emptyset$.

    \If{$i=1$}{
        \For{$1\leq b\leq d$ and $0\leq s\leq \br{k/pn \text{\textbf{ if} }c\br{v}>pk \text{\textbf{ else} 0}}$}{
            $D\gets P$.

            Try putting query to $v$ at the $s$-th slot of $q_b$.

            \If{\textnormal{there are no conflicts in $D$.}}{
                \For{$D'\in \mathcal{A}[v]$}{
                    Hang $D'$ below query to $v$ in $D$.
                }
                \If{$\COST'_{D}\br{T_{v,i},c,k}\leq dk$}
                {
                    $P'\gets$ left box-path of $D$.

                    $h\gets$ index of the last box $q_h$ occupied by the query to $v$.

                    \For{$h < j\leq d$}{
                        $b'_j\gets 0$, $t'_j\gets $ False.
                    }
                    $D'\gets \FDPTimelinesCosts\br{T_{c_1},c, P'}$.

                    Put query to $v$ at he $s$-th slot of $q_b$.

                    Rotate left path of $D'$ around $v$.

                    $\mathcal{D}\gets \mathcal{D} \cup \brc{D \text{ and } D' \text{ with their left paths aligned}}$.
                }
            }
        }
    }
    \Else{
        \ForEach{\textnormal{bipartition $\br{P_1, P_2}$ of $P$}}{
            $D_1\gets \FDPTimelinesCosts\br{T_{v, i-1}, c, P_1}$.

            $h\gets$ index the last box $q_{1,h}$ occupied by the query to $v$.

            \For{$h\leq j\leq d$}{
                        $b_{2,j}\gets 0$, $t'_{2,j}\gets $ False.
                    }

            $D_2\gets \FDPTimelinesCosts\br{T_{c_i}, c, P_2}$.

            Rotate left path of $D'$ around $v$.

            $\mathcal{D}\gets\mathcal{D}\cup\brc{D_1 \text{ and } D_2 \text{ with their left paths aligned}}$.
        }
    }
    \Return{$\argmin_{D\in \mathcal{D}}\brc{\COST'_D\br{T_{v,i},c, k}}$}.
    }

\end{algorithm}
